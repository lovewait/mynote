## 通信子网的操作方式和网络层提供的服务
### 网络层的功能
> 网络层的目的是实现两个端系统之间的数据透明传送具体功能包括路由选择、拥塞控制和网际互连等
### 通信子网的两种操作方式(提供的服务、两种子网的比较)
+ 虚电路操作方式
+ 数据报操作方式

#### 虚电路服务
> 为了建立端系统之间的虚电路，源端系统的传输层首先向网络层发出连接请求，网络层则通过虚电路网络访问协议向网络节点发出呼叫分组;最后,接收方传输层向发起方发回连接响应,从而使虚电路建立起来.此后,两个端系统之间就可以传送数据.数据由网络层拆成若干个分组送给通信子网,由通信子网将分组传送到数据接收方.
#### 数据报服务
> 数据报服务一般仅由数据报交换网来提供.端系统的网络层同网络节点中的网络层之间,一致地按照数据报操作方式交换数据.当端系统要发送数据时,网络层给该数据附加上地址、序号等信息,然后作为数据发送给网络节点;目的端系统收到的数据报可能是不按序到达的,也可能有数据报的丢失.数据报服务与OSI的无连接网络服务类似.

####两种子网的比较
+ 虚电路
    1. 需要建立虚电路
    2. 分组包含一个很短的虚电路号
    3. 每个虚电路都要求路由器为每个连接建立表项
    4. 当虚电路建立的时候选择路径,所有的分组都沿着这条路径
    5. 路由器失效时,所有经过此失效路由器的虚电路都将终止
    6. 如果有足够的资源可以提前分配给每一个虚电路,则很容易实现服务质量
    7. 如果有足够的资源可以提前分配给每一个虚电路,则很容易实现拥塞控制
+ 数据报
    1. 不需要建立虚电路
    2. 每个分组包含完整的源地址和目标地址
    3. 路由器不保留任何有关连接的状态信息
    4. 每个分组被独立的路由
    5. 路由失效时,没有影响,除非在崩溃过程中分组丢失
    6. 很难实现服务质量
    7. 很难实现拥塞控制

## 路由选择
### 最优化原则的定义
如果路由器J在从路由器I到K的最佳路由上,那么从J到K的最佳线路就会在同一路由之中.
### 静态路由选择策略
静态路由选择算法是一类不用测量也不需要利用网络信息,而按某种固定规则进行路由选择的算法.
### 最短路由选择算法
最短路由选择算法是一种简单易懂而应用广泛的技术.它的基本思想是:简历一个子网图,图中的每个节点代表一台路由器,每条弧线代表一条通信线路(链路),弧上的数字代表该线路的权重.为了在一对给定的路由器之间选择一条路由路径,路由选择算法只需在图中找到这对节点的最短路径即可.对于路径长度的测量有多种方法.一种方法是计算站点数量,另外也可以计算距离、信道带宽、平均通信量、通信开销、队列长度、传播时延等.
### 泛射路由选择算法
一个网络节点从某条线路受到一个分组后,再向除该条线路外的所有线路发送收到的分组.结果,最先到达目的节点的一个或若干个分组肯定经过了最短的路径,而且所有可能的路径都被尝试过.
### 动态路由选择策略
### 距离矢量路由算法
距离矢量路由算法是这样工作的:每个路由器维护一张路由表(即一个矢量),它以子网中每个路由器为索引,表中列出了当前已知的路由器到每个目标路由器的最佳距离,以及所使用的线路.通过在邻居之间相互交换信息,路由器不断的更新它们内部的路由表.
### 链路状态路由算法
该算法可以用以下5个部分加以描述.每个路由器必须完成以下的工作:
1. 发现它的邻居节点,并知道其网络地址
2. 测量到各邻居节点的延迟或者开销
3. 构造一个分组,分组中包含所有它刚知道的信息
4. 将这个分组发送给所有其他的路由器
5. 计算出到每一个其它路由器的最短路径
### 移动主机的路由选择
当一个新用户进入某区域或与当地网络相连,或者进入该无线单元时必须将自己登录到当地的外地代理.典型的登录工作过程如下:
1. 外地代理定期广播一个分组,宣布自己的存在及其地址.一个新来的移动主机可以等待这类消息.移动主机可以广播一个分组问:这里有没有外部代理?
2. 移动主机登录到外地代理,并给出其原来所在地的地址,当前数据链路层地址以及一些安全性信息.
3. 外地代理与移动主机的主代理联系,核实移动主机是否真的在那
4. 主代理检查安全性信息(由外地代理核实时发来),如果核实通过,则通知外地代理继续
5. 当外地代理从主代理处得到确认后,在它的表中加入一个表项,并通知移动主机登录成功
### 广播路由选择
同时给所有的目标发送一个分组成为广播.方法有:
1. 简单的给每个目标单独发送一个分组
2. 扩散法
3. 多目标路由
4. 显式地使用了以发起广播的路由器为根的汇集树.或者也可使用任何其他适当的生成树
5. 逆向路径转发
### 多播路由选择
> 每个路由器计算一棵生成树,该生成树覆盖所有其他的路由器.有的路由器上连接了一些属于一个或者两个组的主机.当一个进程给一个分组发送多播分组的时候,第一个路由器检查它的生成树,并对该数进行修剪,去掉那些并不通向该组成员主机的所有线路.多播分组只沿着正确的生成树被转发.修剪生成树有很多中可能的方法.
> 最简单的修剪方法用于那些采用了链路状态路由算法的网络,这时候每个路由器都知道完整的拓扑结构,包括那些主机属于哪些组.然后,修剪工作从每条路径的末端开始,逐步向根路由器前行,同时去掉所有不属于相应组的路由器.
## 拥塞控制
### 拥塞现象的原因
1. 多条流入线路有分组到达,并需要同一输出线路,此时,如果路由器没有足够的内存来存放所有的这些分组,那么有的分组就会丢失
2. 路由器的慢速处理器的缘故,以至于难以完成必要的处理工作(如缓冲区排队,更新路由表等).那么,即使有多余的线路容量,分组也需要进入到队列之中.

### 流量控制和拥塞控制的差异
> 拥塞控制的任务是确保子网能够承受所到达的流量.这是一个全局性的问题,设计各方面的行为,包括所有的主机、所有的路由器、路由器内部的存储--转发处理过程,以及所有可能会削弱子网承载容量的其它因素.与此相反,流量控制只与特定的发送方和特定的接收方之间的点流量有关,它的任务是,确保一个快速的发送方不会持续地以超过接收方吸收能力的速率传输数据.流控制通常涉及的做法是接收方向发送方提供某种直接的反馈,以便告诉发送方另一端的情形到底怎么样.
### 拥塞控制的必要性
> 网络的吞吐量与通信子网负荷(即通信子网中正在传输的分组数)有着密切的关系.当通信子网负荷比较小时,网络的吞吐量(分组数/秒)随网络负荷的增加而线型增加.当网络负荷增加到某一值后,若网络吞吐量反而下架,则表征网络中出现了拥塞现象.在一个出现拥塞现象的网络中,到达某个节点的分组将会遇到无缓冲区可用的情况,从而使这些分组不得不由前一节点重传,或者需要由源节点或源端系统重传.当拥塞比较严重时,通信子网中相当多的传输能力和节点缓冲器都用于这种无谓的重传,从而使通信子网的有效吞吐量下降,有次引起的恶性循环,使通信子网的局部甚至全部处于死锁状态,最终导致网络有效吞吐量接近为零.
## 服务质量
### 集成服务和区分服务的概念
+ 集成服务

> 在集成服务体系结构中,主要的IETF协议是资源预留协议(Resource Reservation protocol,RSVP).利用该协议可以完成资源预留工作;若要发送数据则还需要使用其他的协议.RSVP允许多个发送方给多个接收组传送数据,也允许接收方单独自由地切换信道,并且在优化使用带宽的同时消除阻塞的发生.在进行资源预留的时候,接收方可以(有选择地)指定一个或者多个期望的数据.它也可以指定在预留期间这些选择是否固定不变,或者指定它是否希望以后还可以改变数据源.路由器利用这些信息来优化带宽的使用计划.尤其是,如果两个接收方都同意以后不再改变数据源的话,那么它们只需共享一条路径即可.

+ 区分服务
> 更加简单的服务质量方法,该方法不要求提前建立流,它主要由每台路由器在局部范围内实现,而不牵涉到整条路径.这种方法叫做基于类别的服务质量.IETF已经对这种方法的体系结构进行了标准化,称为区分服务.
### 标签交换和MPLS的概念
+ 标签交换
> 在每个分组的前端增加一个标签,然后根据这个标签而不是根据目标地址进行路由.将这个标签作为内部表中的一个索引值,就可以把"找到正确的输出线路"这件事情变成简单的表格查询,利用这样的技术,路由过程可以很快地完成,而且沿途预留必要的资源也很容易做到

+ MPLS
> 多协议标签交换协议.所谓多协议是指不但支持IPv4,还支持多种网络协议,如IPv6、IPX、Appletalk和DECnet等.它最初是由Cisco等网设备公司提出的.在技术上是把第二层交换机的交换速度引入到路由器,使路由器在做出转发决定时,以一种简单的标签为参照,不再根据目标MAC地址和对应的IP地址做复杂的寻由查找.随着MPLS的完善,目前它已经成为流量工程和VPN的重要手段.

## 网络互连
### 网络互联的基本原理#
要实现网际互连,必须:
1. 在网络之间至少提供一条物理上连接的链路,并具有对这条链路的控制规程;
2. 在不同网络的进程之间提供合适的路由实现数据交换;
3. 有一个始终记录不同网络使用情况并维护该状态信息的计费服务;
4. 在提供以上服务时,尽可能不对互连在一起的网络体系结构作任何修改.
### 网桥技术
首先数据由用户提交给LLC.LLC实体附加了一个头部信息后先把它递交给MAC实体,MAC层再附加一个头部和尾部从而形成一个MAC帧.根据帧中的地址所包含的目的MAC地址,桥把这个包接收下来.桥并不把MAC字段分隔,而是原封不动的转发给目的LAN.因此该帧最后被注入目的LAN,并由目的站点接收.
### RIP和OSPF
> 路由信息协议(Routing Information Protocol,RIP)实际上是一个简单的距离向量路由协议.RIP可以在主机或路由器中实现.因此RIP协议被分为两种不同类型的操作方式.主机中实现的RIP工作在被动状态,它不会传递自己路由表中的信息给别的路由器,它只是接收其他RIP路由器广播的路由信息,并且根据收到的路由信息更新自己的路由表,路由器中实现的RIP工作在主动状态,它定期把路由器信息传递给其它RIP路由器.并且根据收到的RIP消息来更新自己的路由表.这也就是说,被动RIP只接收,而主动RIP则发送和接收RIP消息.
> 每个RIP路由器都保存了一张路由表,每一项对应着一个目的地,其中,每项包括了目的地的IP地址、到目的地的路径距离的度量、到目的地的路径的下一个路由表的IP地址(如果目的地是直接连接的,则不需要这个字段)、路由改变标志(只是这个路由信息是否最近被改变过)以及和这条路由有关的一些计时器.RIP采用的距离度量是一种非常简单的到目的地距离的测量方式:站点技术度量,路由器把到它直接连接的网络的距离定义为I,如果距离为n,表示它到达目的地途中要经过n个路由器,即距离给出了该路由要经过的路由器个数.
### 网桥、路由器和网关等网际互连所使用的中继设备及其对应的OSI层次
+ 网桥
    - 网桥是一种存储转发设备,用来连接类型相似的局域网.从互连网络的结构看,网桥属于DCE级的端到端的连接;从协议层次看,网桥属于链路层范畴,在该层对数据帧进行存储转发.它既不同于只作单纯信号增强的转接器,也不同于进行网络层转换的网间连接器.但网桥仍然是一种网络连接方法,因为局域网本身没有网络层,只有在主机站点上才有网络层或提供网络层服务的功能.
    - 网桥接收帧并送到数据链路层进行差错校验,然后送到物理层再经物理传输介质送到另一个子网.在转发帧以前,网桥对帧的内容和格式不作修改或仅作很少的修改.网桥应该有足够的缓冲空间,以便能满足高峰负荷时的要求.另外,网桥必须具备寻址和路由选择的逻辑功能.
+ 路由器
    - 和网桥的区别
        * 网桥工作在数据链路层,而路由器工作在网络层.网桥利用物理地址(MAC地址)来确定是否转发数据帧,而路由器则根据目的IP地址来确定是否转发该分组
        * 如果使用网桥去连接两个局域网,那么两个局域网的物理层与数据链路层协议可以是不同的,但数据链路层以上的高层要采用相同的协议.如果使用路由器去连接两个局域网,那么两个局域网的物理层、数据链路层与网络层协议可以是不同的,但网络层以上的高层要采用相同的协议
        * 网桥工作在数据链路层,由于传统局域网采用的是广播的方式,因此容易产生"广播风暴"问题,而路由器可以有效地将多个局域网的广播通信量相互隔离开来,是的互连的每个局域网都是独立的子网.
    - 主要服务功能
        1. 建立并维护路由表.为了实现分组转发功能,路由器内部有一个路由表数据库与一个网络路由状态数据库.在路由表数据库中,保存着路由器每个端口对应连接的节点地址以及其它路由器的地址信息.路由器通过定期与其他路由器和网络节点交换地址信息来自动更新路由表.路由器之间还需要定期地交换网络通信量、网络结构与网络链路状态等信息,这些信息保存在网络路由状态数据库中
        2. 提供网络间的分组转发功能.每当一个分组进入路由器时,路由器检查报文分组的源IP地址与目的IP地址,然后根据路由表数据库的相关信息,决定该分组往下应该传送给哪一个路由器或主机.
        3. 路由器的基本工作原理
            1. 互联网络的协议结构
            2. 用路由器互连的网络系统中的传输过程
+ 网关
    - 网管也称为协议转换器,用于高层协议的转换,对传输层到应用层均能支持
    - 若两互联网络的主机高层中仅传输层协议不同,则可以利用网关的功能在传输层间协议转换,内容包括数据格式的重新装配、长数据的分段、地址格式的转换即操作规程的适配等.在高层协议转换的实际实现中,并不一定要分层进行.

### 网桥、交换机、路由器的基本工作原理
### 网络互连的概念
> 网际互连的目的是使一个网络上的用户能访问其他网络上的资源,使不同网络上的用户互相通信和交换信息.这不仅有利于资源共享,也可以从整体上提高网络的可靠性
### 网络互连模型
> 局域网(LAN)、广域网(WAN)的网际互连有"LAN-LAN"、"LAN-WAN"、"WAN-WAN"和"LAN-WAN-LAN"四种形式.由于非OSI系统要与OSI系统互连,实际上,两个网络之间要互连时,他们之间的差异可以表现在OSI七层模型中的任何一层上.
### 网络互连设备
+ 转发器(Repeater)
+ 网桥(Bridge)
+ 路由器(Router)
+ 网关(Gateway)

## 因特网的互连层协议
### ICMP协议
> 互联网控制报文协议ICMP.从IP互联网协议的功能,可以知道IP提供的是一种不可靠的无连接报文分组传送服务.若路由器或主机故障使网络阻塞,就需要停止发送主机采取相应措施.
> 为了使互联网能报告差错,或提供有关意外情况的信息,在IP层加入了一类特殊用途的报文机制,即互联网控制报文协议ICMP
分组接收方利用ICMP来通知IP模块发送方某些方面所需的修改.ICMP通常是由发现别的站发来的报文有问题的站产生的,如果一个分组不能传送,ICMP便可以被用来警告分组源,说明有网络、主机或端口不可达.ICMP也可以用来报告网络阻塞.ICMP是IP正式协议的一部分,ICMP数据报通过IP送出,因此它在功能上属于网络第三层,但实际上它是像第四层协议一样被编码的.
### IGMP协议
> 通常的IP通信是在一个发送方和一个接收方之间进行的,称为单播(Unicast).局域网中可以实现对所有网络节点的广播(Broadcast).但对于有些应用,需要同时向大量接受者发送信息,这些应用是一个发送方对应多个接收方,接收方可能不是网络中的所有主机,也可能没有位于同一个子网.这种通信方式被称为组播或多播(Multicast)
多播需要特殊的多播路由器支持,多播路由器可以兼有普通路由器的功能.因为组内主机的关系是动态的,因此本地的多播路由器要周期性地对本地网络中的主机进行轮询,要求网内主机报告其进程当前所属的组,各机会将其感兴趣的D类地址返回,多播路由器以此决定哪些主机留在那个组内.若经过几次轮询在一个组内已经没有主机是其中的成员,多播路由器就认为该网络中已经没有主机属于该组,以后就不再向其他的多播路由器通告组内成员的状况.
> 多播路由器和主机间的询问和响应过程使用因特网组管理协议(Internet Group Management Protocol,IGMP)进行通信.IGMP类似于ICMP,但只有两种报文:询问和响应,都有一个简单的固定格式,其中数据字段中的第一个字段是一些控制信息,第二个字段是一个D类地址.IGMP使用IP报文传递其报文,具体做法是IGMP报文加上IP报文头部构成IP报文进行传输,但IGMP也向IP提供服务.通常不把IGMP看作一个单独的协议,而是看做整个互连网络协议IP的一个组成部分.
### IP协议
> 互联网协议IP(Internet Protocol)是互连层最重要的协议,它将多个网络连城一个互连网,可以报高层的数据以多个数据报的形式通过互连网分发出去.互连层的功能主要由IP来提供,主要用于负责IP寻址、路由选择和IP数据报的分割和组装
> IP的基本任务是通过互联网传送数据报,各个IP数据报之间是相互独立的.主机上的IP层向传输层提供服务.IP从源传输实体取得数据,通过它传给目的主机的IP层.IP不保证服务的可靠性,在主机资源不足的情况下,它可能丢弃某些数据报,同时IP也不检查被丢弃的报文.
在传送时,高层协议将数据传给IP,IP再将数据封装为互联网数据报,并交给主机-网络层协议通过局域网传送.若目的主机直接连在本网中,IP可直接通过网络将数据报传给目的主机;若目的主机在远地网络中,则IP路由器传送数据报,而路由器则依次通过下一网络将数据报传送到目的主机或再下一个路由器.也即一个IP数据报是通过互连网络,从一个IP模块传送到另一个IP模块,直到终点为止.
> IP协议提供了不可靠的、无连接的数据报传输机制.TCP/IP是为了适应物理网络的多样性而设计的,而这种适应性主要是通过IP层来体现的.由于物理网络的多样性,各种物理网络的数据帧格式、地址格式之间的差异很大.为了将这些底层的细节屏蔽起来,使得采用不同的物理网络的网络之间进行通讯,TCP/IP分别采用了IP数据报和IP地址作为物理数据帧与物理地址的统一描述形式.这样IP向上层提供统一的IP数据报和统一的IP地址,使得各种物理帧及物理地址的差异性对上层协议不复存在.

+ IP数据头:
一个IP数据报由一个头部和数据部分构成.头部包括一个20字节的固定长度部分和一个可选任意长度部分.头部各部分介绍如下:
    1. 版本:4位.记录了数据报对应的协议版本号.当前的IP协议有两个版本:IPV4和IPV6.
    2. IHL:4位.代表头部的总长度,以32位字节为一个单位
    3. 服务类型:8位.使主机可以告诉子网它想要什么样的服务
    4. 总长:16位.指头部和数据的总长.最大长度是65535个字节
    5. 标识:16位.通过它使目的主机判断新来的分段属于哪个分组,所有属于同一分组的分段包含同样的标识值
    6. DF:代表不要分段.它命令路由器不要将数据报分段,因为目的端不能重组分组.
    7. MF:代表还有进一步的分段,用它来标志是否所有的分组都已到达.除了最后一个分段的所有分段都设置了这一位
    8. 分段偏移:13位.标明分段在当前数据报的什么位置
    9. 生命期:8位.用来限制分组生命周期的计数器.它在每个节点中都递减,而且当在一个路由中排队时可以倍数递减
    10. 协议:8位.说明将分组发送给那个传输进程,如TCR、VDP等
    11. 头校验和:16位.仅用来校验头部.
    12. 源地址:32位.产生IP数据报的源IP地址
    13. 目的地址:32位.IP数据报的目的主机的IP地址
    14. 选项:是变长的.每个可选项用一个字节标明内容.有些可选项还跟有一字节的可选项长度字段,其后是一个或多个数据字节.现在已定义了安全性、严格的源路由选择、宽松的源路由选择、记录路由和时间标记五个可选项。但不是所有的路由器都支持全部5个可选项。

### ARP协议
> 在TCP/IP网络环境下,每个主机都分配了一个32位的IP地址,这种互联网地址是在网际范围标识主机的一种逻辑地址.为了让报文在物理网上传送,必须知道彼此的而无力地址.这样就存在把互联网地址变换为物理地址转换问题.以以太网(Ethernet)环境为例,为了正确地向目的站传送报文,必须把目的站的32位IP地址转换成48位的以太网目的地址DA.这就需要在互连层有一组服务将IP地址转换为相应的物理网络地址,这组协议即是ARP.
### RARP协议
> 反向地址转换协议用于一种特殊情况,如果站点初始化以后,只有自己的物理网络地址而没有IP地址,则它可以通过RARP协议,发出广播请求,征求自己的IP地址,而RARP服务器则负责回答.这样,无IP地址的站点可以通过RARP协议取得自己的IP地址,这个地址在下一次系统重新开始以前都有效,不用连续广播请求.RARP广泛用于获取误判工作站的IP地址
### IPv6
+ IPv6把IP地址增加到128比特,使地址空间增大了296倍,它可以为地球上每平方米面积分配以前多个IP地址,这个近似无限的地址空间可以保证IP地址的分配不会再出现过去的窘迫局面.
+ 灵活的IP报文头部格式.IPv6采用一种全新的报文格式,使用一系列固定格式的扩展头部取代了IPv4中可变长度的选项字段.IPv6中选项部分的出现方式也有变化,使路由器可以简单跳过选项而不做任何处理,加快了报文处理速度.
+ 简化协议,加快报文转发.IPv6简化了报文头部格式,将字段从IPv4的13个减少到7个,报文分段也只是在源主机进行,这些简化使路由器可以更快地完成对报文的处理和转发,提高了吞吐量.
+ 提高安全性.鉴于IPv4中出现的种种安全问题,IPv6全面考虑和支持协议的安全功能.身份认证和隐私权是IPv6的关键特性.
+ 支持更多的服务类型.如支持对网络资源的预分配,以实现实时视频传输等要求保证一定带宽和时延的应用.
+ 允许协议继续演变,增加新的功能,使之适应未来技术的发展.
